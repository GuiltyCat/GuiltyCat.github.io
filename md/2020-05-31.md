圧縮ファイルの画像をブラウザ経由で見る
===============

注意
--------

ここで紹介する内容は非常に危険です．
もし利用されっる場合は，細心の注意が必要です．

個人が利用するLAN内だけで運用し，
なおかつ厳重なアクセス管理をして下さい．

外部からの攻撃を受ける危険性が高いだけでなく，
他人の著作物に外部からアクセスできた場合，
著作権者に無断で公開することになり，
違法アップロードが成立する可能性があります．

はじめに
-------------

iPadはクソな仕様がいくつかある．

- 一つはアダルティなコンテンツが排除されている
- ネットワーク上のファイルを望みのアプリで開けない
- 有料アプリが多い

そして，iPadあら自分のデスクトップPCのファイルにアクセスして，
アダルティな画像やzipやrarを観賞したい．
こういうコンテンツは高画質命なので，
大容量のHDDに漫画を保存している．
(画像とか動画って減らせても増やせないから面倒．)

一々コピペとかするのは面倒だし，
iPadの容量も最低のものを使っているので，
そんなことができるストレージの余裕はない．
なので，ネットワークごしにiPadあらアクセスして読みたい．

FTPとかWebDAVとかなら広告付きのが無料であるが，
広告なんて視界の端にすら入れたくない．
また，金を払えばSAMBAとかに対応したアプリもあるが，
私の辞書に課金という言葉は存在しない．

ということで，同様のことが無料でできないか考えた結果，
CGIで簡易漫画ビューワとファイルブラウザを作ることにした．

FTPだと認証が緩いのでちょと怖いというのもあった．

VPNとかを使えば，一応外部からもアクセスできるが，
画像の圧縮なんかしないので，モバイル通信だとやばいと思うし，
余計なリスクが増えるからやらない方がよいと思う．


環境
---

- ArchLinux
- Apache
- Bash


今回作ったもの
------------

プログラム自体は[ここ](https://github.com/GuiltyCat/fbvvwb)を参照して欲しい．

このCGIはアクセスしてきたユーザーのホームディレクトリ以下のファイルを参照できる．
具体的には，

- 画像を見たり，
- 画像の入ったzipやrarを開いたり
- 動画を見たり
- ファイルを削除したり

もっともっと色々な機能を追加できるが，とりあえずこれだけできれば満足．

技術的ポイント
-------------

滅茶苦茶単純なbashだし，
むしろ汚ないコードが多いが，
ちょっとだけ工夫ポイントがある．


最後に
------------

ほぼほぼ完成した．
ただ，画像ビューモードで，画像サイズが違うとちょっと面倒．

そして，この記事もこのCGIにもっとフォーカスして，
英語のフルバージョンで別記事にする．
(といってもCGIに書いた内容のコピペだが．)

英語Apacheの記事はどうしようか．
あれもあれで中身が薄い．

(補足)Apacheの設定
---------------

この内容は本当に最低限で，
セキュリティ的には全然足りていない．

なので，各自できちんと調べた上で設定して欲しい．

	
まず，ApacheのCGIを有効にしておく，設定ファイルはこれだ．

```
/etc/httpd/conf/httpd.conf
```

そしてほとんどの設定はここをいじる．
`http://<ip>`でアクセスされる場所は以下の場所のようだ

```
DocumentRoot "/srv/http"
```

そして，Apacheは安全のためかデフォルトではCGIのモジュールを読み込まない．
なので，

```
LoadModule cgi_module modules/mod_cgi.so
LoadModule cgid_module modules/mod_cgid.so
```

のどっちか使う方をアンコメントする．

また今回のスクリプトの拡張子は`.bash`なのでこれを登録しておくといいかもしれない．

```
AddHandler cgi-script .cgi .bash
```

環境によっては，`Options`に`ExecCGI`を設定しないといけない場合がある．
また，`suexec`を使い，アクセスできるユーザーを特定しておく．

```
SuexecUserGroup <user name> <user name>
<Directory "/srv/http/cgi-bin">
	AllowOverride None
	Options None
	AuthType Digest
	AuthName "<authentication name>"
	AuthUserFile "<file path created by htdigest>"
	Require valid-user
</Directory>
```

さすがにBasicは恐いので，気休めだがDigest認証を使う．

また，今回はユーザーディレクトリを使うので，homeにアクセスできるようにしておく．

```
<IfModule userdir_module>
    UserDir disabled
    UserDir enabled <user name>
    UserDir ./
</IfModule>
...
<Directory "/home/*">
    AllowOverride None
    Options FollowSymLinks Indexes
    AuthType Digest
    AuthName "<authentication name"
    AuthUserFile "<file path created by htdigest"
    Require valid-user
</Directory>
```


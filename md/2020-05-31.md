ブラウザ経由で自分のPCのzip画像を見る
===============

[FBVVWB](https://github.com/GuiltyCat/fbvvwb)というCGIを開発してみました．

Googleの検索結果に表示されず，
他に手段がないので許して下さい．

注意
--------

ここで紹介する内容は非常に危険です．
もし利用されっる場合は，細心の注意が必要です．

個人が利用するLAN内だけで運用し，
なおかつ厳重なアクセス管理をして下さい．

外部からの攻撃を受け，PC内の情報が漏洩する危険性が高いだけでなく，
他人の著作物に外部からアクセスできた場合，
著作権者に無断で著作物を公開することになり，
違法アップロードが成立する可能性があります．

はじめに
-------------

iPadはクソな所がいくつかある．

- 一つはアダルティなコンテンツが排除されている
	- もちろんブラウザ経由であればOKだが
- ネットワーク上のファイルを望みのアプリで開けない
- 有料アプリが多い

そして，iPadから自分のデスクトップPCのファイルにアクセスして，
アダルティな画像やzipやrarを観賞したい．
こういうコンテンツは高画質命なので，
大容量のHDDに漫画を保存している．
(画像とか動画って一度減らしたら今度は増やせないから面倒．)

一々PCからiPadにコピペとかするのは面倒だし，
iPadの容量も最低のものを使っているので，トレージの余裕はない．
なので，ネットワーク経由でiPadからPCにアクセスして鑑賞したい．

FTPとかWebDAVとかなら広告付きのが無料であるが，
広告なんて視界の端にすら入れたくない．
また，金を払えばSAMBAにも対応したストリーミング対応のアプリがあるが，
私の辞書にソフトウェアに対する課金という言葉は存在しない．
FTPだと認証が緩いのでちょと怖いというのもあった．

ということで，同様のことが無料でできないか考えた結果，
CGIで簡易漫画ビューワ兼ファイルブラウザを作ることにした．
それだけじゃなくて，便利に使いたいから色々とつっこんだけっか，
そこそこ色々できるようになった．

VPNとかを使えば，一応外部からもアクセスできるが，
画像の圧縮なんかしないので，通信量がやばい．
余計なリスクが増えるからやらない方がよいと思う．


環境
---

- ArchLinux
- Apache
- Bash

環境と言って良いのか分からないが，HTML5に準拠したつもり．


今回作ったもの
------------

このCGIはアクセスしてきたユーザーのホームディレクトリと`/mnt`以下のファイルを参照できる．
具体的には，

- 画像を見たり，
- 画像の入ったzipやrarを開いたり
- 動画を見たり
- 音楽を聞いたりい
- ファイルを削除したり

もっともっと色々な機能を追加できるが，とりあえずこれだけできれば満足．

構造
-------------

滅茶苦茶単純なbashだし，
むしろ汚ないコードが多いが，
ちょっとだけ工夫ポイントがある．

注意点
------

今まで気付いてなかったんだけど，
bashって`$()`とか使うとサブプロセスが走って変数にアクセスできても更新はできない．
それだけじゃなくて，通常のパイプとかでも．

それに嵌った．
例えば次のコードだと最後の出力は$0$だ．

```
COUNTER=0
for i in $(seq 10); do
	sort "${i}.txt"  | while read -r j;do
		COUNTER=$((COUNTER+1))
	done
done
echo "${COUNTER}"
```

これを防ぐには，パイプをなくして次のようにする．

```
COUNTER=0
for i in $(seq 10); do
	while read -r j;do
		COUNTER=$((COUNTER+1))
	done < <(sort "${i}.txt")
done
echo "${COUNTER}"
```

これはまだいいの．
問題はこっち`$()`．
こんなコードで，`QUERY`を更新したいのにー．
ということがあった．

```
QUERY="a"
function Query(){
	QUERY="b"
	echo "http://localhost"
}
echo "<a href=\"$(Query)\">Hello</a>"
echo "${QUERY}"
```

これは少し汚くなるが，直接呼び出すしかないのだろうか．

```
QUERY="a"
function Query(){
	QUERY="b"
	echo -n "http://localhost"
}
echo -n "<a href=\""
Query
echo "\">Hello</a>"
echo "${QUERY}"
```


最後に
------------

ほぼほぼ完成した．
ただ，画像ビューモードで，画像サイズが違うとちょっと不便．

そして，この記事もこのCGIにもっとフォーカスして，
英語のフルバージョンで別記事にするつもりだったが，
GitHubのREADME.mdで十分か．

英語Apacheの記事はどうしようか．
あれもあれで中身が薄い．

(補足)Apacheの設定
---------------

この内容は本当に最低限で，
セキュリティ的には全然足りていない．

なので，各自できちんと調べた上で設定して欲しい．

	
まず，ApacheのCGIを有効にしておく，設定ファイルはこれだ．

```
/etc/httpd/conf/httpd.conf
```

そしてほとんどの設定はここをいじる．
`http://<ip>`でアクセスされる場所は以下の場所のようだ

```
DocumentRoot "/srv/http"
```

そして，Apacheは安全のためかデフォルトではCGIのモジュールを読み込まない．
なので，

```
LoadModule cgi_module modules/mod_cgi.so
LoadModule cgid_module modules/mod_cgid.so
```

のどっちか使う方をアンコメントする．

また今回のスクリプトの拡張子は`.bash`なのでこれを登録しておくといいかもしれない．

```
AddHandler cgi-script .cgi .bash
```

環境によっては，`Options`に`ExecCGI`を設定しないといけない場合がある．
また，`suexec`を使い，アクセスできるユーザーを特定しておく．

```
SuexecUserGroup <user name> <user name>
<Directory "/srv/http/cgi-bin">
	AllowOverride None
	Options None
	AuthType Digest
	AuthName "<authentication name>"
	AuthUserFile "<file path created by htdigest>"
	Require valid-user
</Directory>
```

さすがにBasicは恐いので，気休めだがDigest認証を使う．

また，今回はユーザーディレクトリを使うので，homeにアクセスできるようにしておく．

```
<IfModule userdir_module>
    UserDir disabled
    UserDir enabled <user name>
    UserDir ./
</IfModule>
...
<Directory "/home/*">
    AllowOverride None
    Options FollowSymLinks Indexes
    AuthType Digest
    AuthName "<authentication name"
    AuthUserFile "<file path created by htdigest"
    Require valid-user
</Directory>
```


iPadからブラウザ経由でPCのzip画像を見る
===============

[FBVVWB](https://github.com/GuiltyCat/fbvvwb)というCGIを作りました．

個人的には満足しているが，
とんでもない穴がある気がするので
公開してみんなの意見を公募したいです．

注意
--------

このCGIは非常に危険です．
もし利用される場合は，細心の注意が必要です．

必ず個人利用のLAN内だけで運用し，
なおかつ厳重なアクセス制限をして下さい．

下手に設定すると，
外部からの攻撃を受けるだけでなく，
他者の著作物の違法アップロードになる可能性があります．

はじめに
-------------

iPadは問題がいくつかある．

- 一つはアプリ内でのアダルティなコンテンツが排除されていること
	- もちろんWeb版であればOKだが面倒
- ネットワーク上のファイルを望みのアプリで開けない
- 有料アプリが多い

iPadから自分のPCのファイルにアクセスして，
そういった画像やzipやrarを観賞したい．
こういうコンテンツは高画質命なので，
大容量のHDDに漫画を保存している．
(画像とか動画って一度減らしたらそれっきり)

(私の場合はそういうコンテンツがメインだが，
自炊マニア向けとしても使えるのではないだろうか．
一応pdfも対応している．)

一々PCからiPadにコピペとかするのは遅いし現実的ではない．
また，iPadの容量の余裕はない．
なので，ネットワーク経由でiPadからPCにアクセスして鑑賞したい．

FTPとかWebDAVとかなら広告付きのが無料であるが，
広告なんて視界の端にすら入れたくない．
また，金を払えばSAMBAとストリーミングに対応したアプリがあるが，
私の辞書に課金という言葉は存在しない．
FTPだと認証が緩いのでちょと怖いというのもあった．

ということで，同様のことが無料でできないか考えた結果，
CGIで簡易zip画像ビューワ兼ファイルブラウザを作ることにした．
使っている内に色々機能が欲しいということで追加し，
検索とか削除まで入れてしまった．

削除の機能は危険なので入れたくないが，
かき集めた画像を整理する時にどうしても必要だった．

VPNとかを使えば，一応外部からもアクセスできるが，
画像の圧縮なんかしないので，通信量がやばい．
余計なリスクが増えるからやらない方がよいと思う．


環境
---

- ArchLinux
- Apache
- Bash

環境と言って良いのか分からないが，HTML5に準拠したつもり．


今回作ったもの
------------

このCGIはアクセスしてきたユーザーのホームディレクトリと`/mnt`以下のファイルを参照できる．
具体的には，

- 画像を見たり(jpg, png, zip, rar)，
- 動画を見たり(.mp4, .avi)
- 音楽を聞いたり
- ファイルを検索したり
- ファイルを削除したり


技術ポイント
-------------

### 1ファイルのbash scriptだけでできている

ごちゃごちゃさせるのは嫌いだし，
ドキュメントのメンテナンスも面倒ということで，
オールインワンのCGIだ．

ドキュメント(README.md)はbashのコメントから自動生成される．
本当は文芸的プログラミング言語みたいなことをしたかった．

### 2.すべてGETとPOSTで画面遷移

ファイルブラウザモードやファイルビューモードなど，
いくつかの画面があるが，
それらは全てクエリを渡すことで実現している．

要はもりもりのクエリがついたリンクを張っておくのだ．

現在の場所，ディレクトリやフォルダを表すのに以下のようなクエリを使っている．

```
cp=/home/happy/hello.jpg
```

そして，`cp`がディレクトリであればファイルブラウザモードになる．
また，ファイルであればその拡張子に応じて，
それを開くためのページを用意している．

それだけだと，ファイルを開いた後に戻るリンクを押すと，
常に一番上のリンクが開いてしまう．
このままだと，ファイル数が多い場合にちょこちょこ中身を除き難くなってしまう．

そこで，ファイルブラウザモードでは全てのリンクに上から順番に連番のidを付け，
一つ上のディレクトリで選択されたファイルのページ内リンクに飛ぶようにしてある．

このクリックした履歴を保存するために以下のようなクエリを用意した．

```
uplink=_0_4_3
```

これはスタックになっている．
ディレクトリの階層が下るにつれて，
`_<num>`がpush(追記)されていく．
逆に上に上るリンクには，最後から`_<num>`がpopされ，
リンクの一番最後にページ内ジャンプである`#<num>`が付け足されている．

1ファイルなので，画面の遷移や


注意点
------

今まで気付いてなかったんだけど，
bashって`$()`とか使うとサブプロセスが走って変数にアクセスできても更新はできない．
それだけじゃなくて，通常のパイプとかでも．

それに嵌った．
例えば次のコードだと最後の出力は$0$だ．

```
COUNTER=0
for i in $(seq 10); do
	sort "${i}.txt"  | while read -r j;do
		COUNTER=$((COUNTER+1))
	done
done
echo "${COUNTER}"
```

これを防ぐには，パイプをなくして次のようにする．

```
COUNTER=0
for i in $(seq 10); do
	while read -r j;do
		COUNTER=$((COUNTER+1))
	done < <(sort "${i}.txt")
done
echo "${COUNTER}"
```

これはまだいいの．
問題はこっち`$()`．
こんなコードで，`QUERY`を更新したいのにー．
ということがあった．

```
QUERY="a"
function Query(){
	QUERY="b"
	echo "http://localhost"
}
echo "<a href=\"$(Query)\">Hello</a>"
echo "${QUERY}"
```

これは少し汚くなるが，直接呼び出すしかないのだろうか．

```
QUERY="a"
function Query(){
	QUERY="b"
	echo -n "http://localhost"
}
echo -n "<a href=\""
Query
echo "\">Hello</a>"
echo "${QUERY}"
```


最後に
------------

ほぼほぼ完成した．
ただ，画像ビューモードで，画像サイズが違うとちょっと不便．

そして，この記事もこのCGIにもっとフォーカスして，
英語のフルバージョンで別記事にするつもりだったが，
GitHubのREADME.mdで十分か．

英語Apacheの記事はどうしようか．
あれもあれで中身が薄い．

(補足)Apacheの設定
---------------

この内容は本当に最低限で，
セキュリティ的には全然足りていない．

なので，各自できちんと調べた上で設定して欲しい．


まず，ApacheのCGIを有効にしておく，設定ファイルはこれだ．

```
/etc/httpd/conf/httpd.conf
```

そしてほとんどの設定はここをいじる．
`http://<ip>`でアクセスされる場所は以下の場所のようだ

```
DocumentRoot "/srv/http"
```

そして，Apacheは安全のためかデフォルトではCGIのモジュールを読み込まない．
なので，

```
LoadModule cgi_module modules/mod_cgi.so
LoadModule cgid_module modules/mod_cgid.so
```

のどっちか使う方をアンコメントする．

また今回のスクリプトの拡張子は`.bash`なのでこれを登録しておくといいかもしれない．

```
AddHandler cgi-script .cgi .bash
```

環境によっては，`Options`に`ExecCGI`を設定しないといけない場合がある．
また，`suexec`を使い，アクセスできるユーザーを特定しておく．

```
SuexecUserGroup <user name> <user name>
<Directory "/srv/http/cgi-bin">
	AllowOverride None
	Options None
	AuthType Digest
	AuthName "<authentication name>"
	AuthUserFile "<file path created by htdigest>"
	Require valid-user
</Directory>
```

さすがにBasicは恐いので，気休めだがDigest認証を使う．

また，今回はユーザーディレクトリを使うので，homeにアクセスできるようにしておく．

```
<IfModule userdir_module>
    UserDir disabled
    UserDir enabled <user name>
    UserDir ./
</IfModule>
...
<Directory "/home/*">
    AllowOverride None
    Options FollowSymLinks Indexes
    AuthType Digest
    AuthName "<authentication name"
    AuthUserFile "<file path created by htdigest"
    Require valid-user
</Directory>
```
